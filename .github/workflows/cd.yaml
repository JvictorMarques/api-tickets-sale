name: Realizando o deploy da aplicação para os ambientes
on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/deploy.yaml
      - .github/workflows/cd.yaml
      - app/Dockerfile
      - app/src/**
      - robot/**
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-staging:
    name: Realizando o deploy para o ambiente de staging
    uses: ./.github/workflows/deploy.yaml
    secrets: inherit
    with:
      RAILWAY_ENVIRONMENT: staging

  robot-tests:
    name: Executando os testes automatizados com Robot Framework
    needs: deploy-staging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12

      - name: Install dependencies
        working-directory: robot
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Robot Framework tests
        working-directory: robot
        env:
          BASE_URL: ${{ vars.BASE_URL }}
          MERCADO_PAGO_PUBLIC_KEY: ${{ secrets.MERCADO_PAGO_PUBLIC_KEY }}
        run: robot .

      - name: Upload Robot Framework reports
        uses: actions/upload-artifact@v4
        with:
          name: robot-reports
          path: |
            robot/report.html
            robot/log.html
            robot/output.xml

  deploy-production:
    needs: robot-tests
    name: Realizando o deploy para o ambiente de production
    uses: ./.github/workflows/deploy.yaml
    secrets: inherit
    with:
      RAILWAY_ENVIRONMENT: production
